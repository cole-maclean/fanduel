(function(){var b=0;var a=this;var c=a.AVLSet=function c(e,f){this.comparator=e;this.weightFetch=f?f:function(){return 1};this.root=null;this.treeId=b++};c.prototype={find:function(i,h){if(i.$avlnodes&&i.$avlnodes[this.treeId]){return i}var f=this.root,g=this.comparator;if(!g){throw new d("NoSetComparator","Cannot search a set by value without a comparator")}while(f){var e=g(i,f.value);if(e===0){return f.value}if(e>0){f=f.right}else{f=f.left}}return h},isMemberValue:function(e){if(e.$avlnodes&&e.$avlnodes[this.treeId]){return true}if(!this.comparator){return false}return this.find(e)?true:false},getIndex:function(i){if(!i.$avlnodes||!i.$avlnodes[this.treeId]){i=this.find(i);if(!i){return false}}var g=i.$avlnodes[this.treeId],e=0,f=g,h=this.weightFetch;e+=(g.left?(g.left.weight+h(g.left.value)):0);g=g.parent;while(g){if(g.right===f){e+=(g.left?(g.left.weight+h(g.left.value)):0)+h(g.value)}f=g;g=g.parent}return e},findByIndex:function(f,k){var j=f,h=this.root,i=this.weightFetch;while(h){var e=i(h.value),g=h.left?h.left.weight+i(h.left.value):0;if(j>=(g)&&(j<g+e)){return h.value}else{if(j>g){j-=(g+e);h=h.right}else{h=h.left}}}return k},add:function(j){var f=this;function g(l,k,m){if(l[k]){return l[k]}l[k]=f.createNode(m,l);f.recalculateAndBalance(l);return null}if(!this.root){this.root=this.createNode(j);return true}else{var i=this.comparator;var h=this.root;if(i){while(true){var e=i(h.value,j);if(e==0){j.$avlnodes=h.value.$avlnodes;h.value=j;return false}else{if(e<0){if(h=g(h,"right",j)){continue}return true}else{if(h=g(h,"left",j)){continue}return true}}}}else{var h=this.root;while(h.right){h=h.right}g(h,"right",j);return true}}},insert:function(j,l){if(this.comparator){throw new d("InsertIntoOrdered","Cannot insert by index into an ordered set")}var g=j,f=this.root,n=this.weightFetch;var i=l.$avlnodes?l.$avlnodes[this.treeId]:false;var m=[];while(f){var h=n(f.value),e=f.left?f.left.weight+n(f.left.value):0;if(g>=(e)&&(g<e+h)){var k=this.createNode(l,f);k.left=f.left;if(f.left){f.left.parent=k}f.left=k;this.recalculateAndBalance(k);return}else{if(g>e){g-=(e+h);if(f.right){m.push(f);f=f.right;continue}f.right=this.createNode(l,f);this.recalculateAndBalance(f);return}else{if(f.left){m.push(f);f=f.left;continue}f.left=this.createNode(l,f);this.recalculateAndBalance(f);return}}}this.root=this.createNode(l);return},remove:function(j){if(!j.$avlnodes||!j.$avlnodes[this.treeId]){j=this.find(j);if(!j){return false}}var h=j.$avlnodes[this.treeId];var g=h.parent?(h.parent.left===h):undefined;if(!h.left){if(!h.right){if(h.parent){if(g){delete h.parent.left}else{delete h.parent.right}this.recalculateAndBalance(h.parent)}else{this.root=null}}else{h.right.parent=h.parent;if(h.parent){if(g){h.parent.left=h.right}else{h.parent.right=h.right}}else{this.root=h.right}this.recalculateAndBalance(h.right)}}else{if(!h.right){h.left.parent=h.parent;if(h.parent){if(g){h.parent.left=h.left}else{h.parent.right=h.left}}else{this.root=h.left}this.recalculateAndBalance(h.left)}else{var e=h.left?((h.left.depth+1)||1):0;var f=h.right?((h.right.depth+1)||1):0;if(e<f){var i=h.right;while(i.left){i=i.left}i.left=h.left;h.left.parent=i;h.right.parent=h.parent;if(h.parent){if(g){h.parent.left=h.right}else{h.parent.right=h.right}}else{this.root=h.right}}else{var i=h.left;while(i.right){i=i.right}i.right=h.right;h.right.parent=i;h.left.parent=h.parent;if(h.parent){if(g){h.parent.left=h.left}else{h.parent.right=h.left}}else{this.root=h.left}}delete h.left;delete h.right;delete h.parent;this.recalculateAndBalance(i,2)}}return true},traverse:function(f,e){e=e||this.root;if(!e){return}if(e.left){this.traverse(f,e.left)}f(e.value);if(e.right){this.traverse(f,e.right)}},getSize:function(){if(this.root){return this.root.realWeight+1}else{return 0}},getIndexCount:function(){if(this.root){return this.root.weight+this.weightFetch(this.root)}else{return 0}},toArray:function(){var e=[];this.traverse(function(f){e.push(f)});return e},isEmpty:function(){return this.getSize()==0},clear:function(){this.root=null},isOrdered:function(){return this.comparator?true:false},createNode:function(g,f){if(!g.$avlnodes){g.$avlnodes={}}var e={value:g,parent:f,weight:0,realWeight:0,depth:0};g.$avlnodes[this.treeId]=e;return e},recalculateAndBalance:function(g){var h=this.weightFetch,e=this;function i(l,m){var j=null;if(m){var k=l.left;l.left=k.right;if(l.left){l.left.parent=l}k.right=l}else{var k=l.right;l.right=k.left;if(l.right){l.right.parent=l}k.left=l}k.parent=l.parent;if(k.parent){if(k.parent.left===l){k.parent.left=k}else{k.parent.right=k}}else{e.root=k}l.parent=k;f(l);return l}function f(o,l){var n=o.left?((o.left.depth+1)||1):0,t=o.right?((o.right.depth+1)||1):0,m=n-t,q=null,j=null;if(l&&Math.abs(m)>1){if(m>0){j=o.left,sl=j.left?((j.left.depth+1)||1):0,sr=j.right?((j.right.depth+1)||1):0;var k=j.left,r=j.right;if(sl-sr<0){q=i(j,false)}i(o,true);if(q){o=q}}else{j=o.right;sl=j.left?((j.left.depth+1)||1):0,sr=j.right?((j.right.depth+1)||1):0;var k=j.left,r=j.right;if(sl-sr>0){q=i(j,true)}i(o,false)}if(q){o=q}return o}o.depth=Math.max(n,t);var s=o.left?(o.left.realWeight+1)||1:0,p=o.right?(o.right.realWeight+1)||1:0,n=o.left?((o.left.weight+h(o.left.value))||1):0;t=o.right?((o.right.weight+h(o.right.value))||1):0;o.weight=n+t;o.realWeight=s+p;return o.parent}while(g){g=f(g,true)}},validateDepth:function(e){function f(g){if(!g){return 0}return Math.max(f(g.left),f(g.right))}if(e.depth!==f(e)){throw new Error("Found wrong depth at: "+e+" ("+e.depth+" != "+f(e)+")")}},validateWeights:function(f){f=f||this.root;if(!f){return 0}var h=0,g=this.weightFetch;var i=f.left?this.validateWeights(f.left):0;var e=f.right?this.validateWeights(f.right):0;if(f.weight!=(i+e)){throw new Error("Found wrong weight at: "+f+" ("+f.weight+" != "+(i+e))}return i+e+g(f.value)},toString:function(p,t){function g(z){var r="";var l="                                        ";while(z>l.length){r+=l;z-=l.length}if(z){r+=l.substring(0,z)}return r}function s(z){var r="";var l="----------------------------------------";while(z>l.length){r+=l;z-=l.length}if(z){r+=l.substring(0,z)}return r}t=t||this.root;if(!t){return"(empty)"}var h,x;if(t.visited){h=x=""}else{h=t.left?this.toString(p,t.left):[];x=t.right?this.toString(p,t.right):[]}var v=p(t.value,t)+(t.visited?" (error)":""),o=v.length,i=Math.max(h.length,x.length,o),k=(h&&h[0])?(h[0].length):1,n=(x&&x[0])?(x[0].length):1,e=k+n,y=e>>1,w=Math.max(o,k+n),f=(w-o)>>1;ll=Math.min(y-1,k>>1),rl=Math.max(y+1,k+(n>>1));t.visited=true;var m=[];m.push(g(f+1)+v+g(w-o-f));if(h.length||x.length){m.push(g(y)+"|"+g(w-y));m.push(g(ll)+(h.length?("+"+s(y-ll-1)):(g(y-ll)))+"+"+(x.length?(s(rl-y)+"+"):g(rl-y+1))+g(w-rl-1));m.push(g(ll)+(h.length?"|":" ")+g(rl-ll)+(x.length?"|":" ")+g(w-rl-1));for(var j=0;j<i;j++){var u=h[j]?h[j]:g(k),q=x[j]?x[j]:g(n);m.push(u+" "+q)}}if(t===this.root){this.clearValidation(this.root);return m.join("\n")}else{return m}},nodeTraverse:function(f,e){e=e||this.root;if(!e){return}if(e.left){this.nodeTraverse(f,e.left)}f(e);if(e.right){this.nodeTraverse(f,e.right)}},validateTree:function(){return;if(!this.root){return}this.validateNode(this.root);this.clearValidation(this.root)},validateNode:function(g){if(g.visited||g.left===g||g.right===g||g.parent===g||(g.left&&g.left.parent!==g)||(g.right&&g.right.parent!==g)||(g.parent&&g.parent.left!==g&&g.parent.right!==g)){var f="";if(g.visited){f="already visited"}else{if(g.left==g){f="left child of self"}else{if(g.right==g){f="right child of self"}else{if(g.parent==g){f="parent of self"}else{if(g.left&&g.left.parent!=g){f="not parent of left child"}else{if(g.right&&g.right.parent!=g){f="not parent of right child"}else{f="not child of parent"}}}}}}var h=new Error("Self referential node detected: "+f);h.type="SelfReferentialNodeException";h.node=g;throw h}g.visited=true;this.validateDepth(g);this.validateWeight(g);if(g.left){this.validateNode(g.left)}if(g.right){this.validateNode(g.right)}},clearValidation:function(e){delete e.visited;if(e.left){this.clearValidation(e.left)}if(e.right){this.clearValidation(e.right)}}};function d(e,f){Error(this,f);this.type=e}d.prototype=new Error();d.prototype.constructor=d;d.prototype.name="AVLSetError"})();(function(){var a=this,e=Backbone.Marionette;var c=e.LazyCompositeView=e.CompositeView.extend({constructor:function(f){e.View.prototype.constructor.apply(this,arguments);this.children=new AVLSet(null,function(g){return g.pendingHeight||1});this.init();this.attachLazyEvents();this.onShowCallbacks=new e.Callbacks()},init:function(){this.lazy={avgHeight:0,pageSize:0,pageCount:0,avgHeight:1,indexTop:0,indexBottom:0,topOffset:0,cache:[]};function f(g){if(!g){return}var h=g.prototype.render;g.prototype.render=function(){var i=h.apply(this,arguments);this.$el.data("lazyView",this);return i}}f(this.getItemView());f(this.getPendingView())},attachLazyEvents:function(){if(this.collection){this.listenTo(this.collection,"add",this.addChildModel,this);this.listenTo(this.collection,"remove",this.removeChildModel,this);this.listenTo(this.collection,"reset",this.reset,this);this.listenTo(this.collection,"sort",this.reset,this);this.listenTo(this.collection,"change",this.changeChildModel,this)}this.updateRows=_.bind(this.updateRows,this);this.attachViewportEvents(this.getViewportContainer())},attachViewportEvents:function(f){f.bind("scroll",_.debounce(_.bind(this.onScrollUpdate,this),100))},recalculatePageCount:function(f){f=(f!==undefined?f:this.children.getIndexCount()-1);var g=this.lazy;if(g.pageSize===0){return}g.pageCount=Math.ceil(f/g.pageSize)},addChild:function(g,i,h){g.render();g.$el.data("lazyView",g);var f=this.getChildContainer();var j=f[0].childNodes;if(i>=j.length){f.append(g.$el)}else{$(j[i]).before(g.$el)}if(!g.model.noTransition&&this.transitionAdd&&!h){this.transitionAdd(g)}this.children.insert(i,g)},addChildren:function(g){_.each(g,function(k){k.view.render();k.view.$el.data("lazyView",k.view)});var f=this.getChildContainer();var j=f[0].childNodes;var h=j.length;var i={appends:$(),prepends:$()};_.each(g,function(k){if(k.index>=h){i.appends=i.appends.add(k.view.$el)}else{i.prepends=i.prepends.add(k.view.$el)}this.children.insert(k.index,k.view);h+=1},this);f.append(i.appends);f.before(i.prepends)},changeChildModel:function(h,g){var j=this.lazy,k=this.collection,i=this.children;var f=j.cache[h.cid];if(f){if(this.transitionChange){this.transitionChange(f)}}},addChildModel:function(h,i,n){var g=this.getItemView(),j=i.indexOf(h),f=this.lazy,m=this.children;if(j<f.topIndex||j>f.bottomIndex){var k=this.children.findByIndex(j);if(k&&!k.pendingHeight&&j>0){k=this.children.findByIndex(j-1)}if(k.pendingHeight){this.updatePendingSegment(k,k.pendingHeight+1);return}}var l=this.buildItemView(h,g);this.addChild(l,j);this.recalculatePageCount()},removeChildModel:function(m,h,n){var i=n.index,l=this.children,k=l.findByIndex(i),g=l.getIndex(k),j=this.getPage(i),f=this.lazy;if(k.pendingHeight){this.updatePendingSegment(k,k.pendingHeight-1)}else{l.remove(k);if(!k.model.noTransition&&k.pendingHeight!==0&&this.transitionRemove){this.transitionRemove(k)}delete this.lazy.cache[k.model.cid]}if(f.paging.length>=j){f.paging.splice(j,f.paging.length)}this.recalculatePageCount()},reset:function(){this.getChildContainer().html("");this.renderChildren()},render:function(){var f=this.renderModel();this.$el.html(f);this.trigger("composite:model:rendered");this.trigger("render");this.trigger("composite:rendered");return this},getView:function(f){return this.lazy.cache[f.cid]},onShow:function(){this.renderChildren()},onShowCalled:function(){},renderChildren:function(){var g=this.lazy,m=this.getViewportContainer(),j=m.height(),h=new Date().getTime();if(j==0){return}var q=j*2,n=this.getChildContainer();var r=n[0];while(r){if(r===document){break}r=r.parentNode}if(!r){return}var f=this.collection.models;if((g.indexTop+g.pageSize)>=f.length){var i=Math.max(0,f.length-g.pageSize);g.indexBottom-=(g.indexTop-i);g.indexTop=i}var l=this.addVisibleItems(n,q,f);if(!l){return}g.avgHeight=Math.floor(n.height()/l);var p=g.pageSize=l>>1;this.recalculatePageCount(f.length-1);var k=g.indexTop?this.getPage(g.indexTop-g.pageSize):0,s=k*g.pageSize,t=f.length-(l+s);if(g.indexTop){var o=this.createPendingSegmentView(s);this.addChild(o,0,true);g.paging=[];g.paging[k]=g.paging[k+1]=h;m.scrollTop(g.indexTop*g.avgHeight+g.topOffset)}else{g.paging=[h,h]}this.addPendingSegment(s+l,t)},addVisibleItems:function(n,q,f){var j=this.getItemView(),p=this.children,g=this.lazy;g.indexTop=g.indexTop||0;p.clear();var h=this.getPage(g.indexTop-g.pageSize)*g.pageSize;var m=[];var l=50;var i=Math.min(f.length,h+l);for(var k=h;k<i;k++){var o=this.buildItemView(f[k],j);m.push({view:o,index:k-h})}this.addChildren(m);return k+1-h},createRanges:function(g){var l={},j={},h=[];function k(n){var m=null;if(m=l[n+1]){l[m.start--]=null;l[m.start]=m}else{if(m=j[n-1]){j[m.end++]=null;j[m.end]=m}else{h.push(l[n]=j[n]={start:n,end:n})}}}for(var i=0,f=g.length;i<f;i++){k(g[i])}return h},findElementFromPosition:function(g,f){var f=f||this.getChildContainer().children();var h=b(f,g,"offsetTop","offsetHeight");return f[h]},findElementFromIndex:function(g){var f=this.children.findByIndex(g);return f?f.$el:null},findIndexFromPosition:function(i,g){var h=this.lazy,l=g?g:this.findElementFromPosition(i),f=this.getLazyView($(l)),k=this.children.getIndex(f);if(f.pendingHeight){var j=Math.min(Math.floor((i-l.offsetTop)/h.avgHeight),f.pendingHeight-1);return k+j}return k},updateRows:function(h,f){var i=new Date().getTime(),g=this.lazy;var m=this.getPage(h+f.length-1);for(var n=this.getPage(h);n<=m;n++){g.paging[n]=i}while(f.length>0){var r=this.findElementFromIndex(h),k=r[0],o=this.getLazyView(r),q=this.children;if(!o){log("View missing for row: %o",r);break}if(o.pendingHeight>1){var l=this.replacePendingSegment(r,h,f);h+=l}else{var j=k.nextSibling,p=k.parentNode;q.remove(o);r.detach();if(j){$(j).before(f[0].$el)}else{$(p).append(f[0].$el)}q.insert(h,f[0]);f.splice(0,1);h++}}},replacePendingSegment:function(u,j,g){var h=this.lazy,p=this.getLazyView($(u)),l=this.children.getIndex(p),k=p.pendingHeight,i=j==l,r=this.children;var o=r.getIndexCount();if(i){var n=Math.min(k,g.length);var f=$(_.map(g.slice(0,n),function(v){return v.$el[0]}));$(u).before(f);for(var m=0;m<n;m++){r.insert(m+l,g[m])}g.splice(0,n);this.updatePendingSegment(p,k-n);return n}else{var s=j-l,t=k-s;var n=Math.min(t,g.length);this.updatePendingSegment(p,s);t-=n;if(t){var q=this.createPendingSegmentView(t);q.$el.height(t*h.avgHeight);$(u).after(q.$el)}var f=$(_.map(g.slice(0,n),function(v){return v.$el[0]}));$(u).after(f);for(var m=0;m<n;m++){r.insert(j+m,g[m])}g.splice(0,n);if(t){r.insert(j+n,q)}return n}},onScrollUpdate:function(){var m=this.lazy,l=this.getChildContainer().children(),x=this.getViewportContainer(),f=x.scrollTop(),h=f+x.height(),t=this.findElementFromPosition(f,l),q=this.findElementFromPosition(h,l),g=this.findIndexFromPosition(f,t),w=this.findIndexFromPosition(h,q);m.topOffset=f-(g*m.avgHeight);if(g!=m.indexTop||w!=m.indexBottom){this.trigger("lazy:show",{top:g,bottom:w});m.indexTop=g;m.indexBottom=w}var u=this.getPage(g-m.pageSize),v=Math.min(m.pageCount-1,this.getPage(w+m.pageSize));var r=[],p=[];for(var n=u;n<=v;n++){if(!m.paging[n]){r.push(n)}else{p.push(n)}}var i=this.createRanges(r);for(var o=0;o<i.length;o++){var s=i[o];if(s.end<s.start){continue}var k=Math.max(s.start*m.pageSize,0),j=Math.min(((s.end+1)*m.pageSize),this.getLength());this.requestPageRange(k,j-k,this.updateRows)}},getLength:function(){return this.children.getIndexCount()},requestPageRange:function(m,k,l){var j=this.getItemView();var h=[];window.myCollection=this.collection;var g=Math.min(m+k,this.getLength());for(var i=m;i<g;i++){var f=this.buildItemView(this.collection.models[i],j);if(!f){continue}f.render();f.$el.data("lazyView",f);h.push(f)}l(m,h)},getPage:function(f){var g=this.lazy;if(g.pageSize===0){return 0}return Math.max(0,Math.min(g.pageCount-1,Math.floor(f/g.pageSize)))},buildItemView:function(i,h){var j=this.lazy,f=i?j.cache[i.cid]:null;if(!f){var k=_.result(this,"itemViewOptions");var g=_.extend({model:i},k);f=new h(g);if(i){j.cache[i.cid]=f}}return f},addPendingSegment:function(h,f){var g=this.createPendingSegmentView(f);this.addChild(g,h,true);return g},updatePendingSegment:function(g,f){var j=this.children,h=j.getIndex(g),i=this.lazy;j.remove(g);if(f){g.pendingHeight=f;g.$el.height(f*i.avgHeight);j.insert(h,g)}else{g.$el.remove();delete i.cache[g.model.cid]}},createPendingSegmentView:function(f){var k=this.lazy,h=this.getPendingView(),j=_.result(this,"pendingViewOptions"),i=_.extend({model:new Backbone.Model()},j),g=new h(i);g.render();if(f){g.$el.height(k.avgHeight*f).removeClass("is-hidden")}else{g.$el.addClass("is-hidden")}g.pendingHeight=f;return g},getPendingView:function(){var f=this.options.pendingView||this.pendingView;if(!f){var g=new Error("A `pendingView` must be specified");g.name="NoPendingViewError";throw g}return f},getChildContainer:function(){var f=this.$childContainer;if(f&&f.length){return f}f=this.$childContainer=(this.viewport?this.$el.find(this.container):this.$el);return f},getViewportContainer:function(){var f=this.$viewportContainer;if(f&&f.length){return f}f=this.$viewportContainer=(this.viewport?this.$el.find(this.viewport):this.$el);if(f){this.attachViewportEvents(f)}return f},getLazyView:function(f){return f.data("lazyView")}});function d(l,k,j){var m=0,g=l.length-1;while(m<g){var h=(m+g)>>1;var f=l[h];var i=j(k,f);if(i>0){if(m===h){h++}m=h;continue}else{if(i<0){if(g===h){h--}g=h;continue}else{m=h;break}}}return m}function b(k,l,h,i){if(typeof(h)=="function"){var f=0,g=k.length-1;while(f<g){var m=(f+g)>>1;var n=h(k[m]);var j=i?i(k[m]):0;if(l>(n+j)){if(f===m){m++}f=m;continue}else{if(l<n){if(g===m){m--}g=m;continue}else{f=m;break}}}return f}else{var f=0,g=k.length-1;while(f<g){var m=(f+g)>>1;var n=k[m][h];var j=i?k[m][i]:0;if(l>(n+j)){if(f===m){m++}f=m;continue}else{if(l<n){if(g===m){m--}g=m;continue}else{f=m;break}}}return f}}})();