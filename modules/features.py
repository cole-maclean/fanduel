import numpy
import pandas as pd
import math
import datetime as dt
import database_operations as dbo

###             FEATURES IDEAS
##---------------------------------------
##Vegas projected points scored
##DVP "average points given up by a defense against a position vs the league average"

##For last 5,10,15 mean/median we have to be careful with these when we cross over between seasons...
###(contd) (for example, last 15 games may have 5 from 2015 season and 10 from 2014 season...how to avoid this??


class FD_features(): #Ian: some features are going to be unique to each sport, maybe split into different classes?
	def __init__(self, sport, features=[]):
		self.sport=sport
		if self.sport=='NBA':
			self.seasons={'2012':['2012-10-30','2013-04-17'],'2013':['2013-10-29','2014-04-16'],
							'2014':['2014-10-28','2015-04-15'],'2015':['2015-10-27','2016-04-16']} #could split this up into 4 quarters for each season for more representative averages
			self.seasons_dt={season:[dt.datetime.strptime(dates[0],'%Y-%m-%d'),dt.datetime.strptime(dates[1],'%Y-%m-%d')] 
									for season,dates in self.seasons.iteritems()}
			self.positions=['PG','SG','SF','PF','C']
			self.teams=['MIL', 'MIN', 'TOR', 'ATL', 'BOS', 'DET', 'DEN', 'NO', 'DAL', 'BKN', 'POR', 'ORL', 'MIA', 'CHI', 
						'NY', 'CHA', 'UTA', 'GS', 'CLE', 'HOU', 'WAS', 'LAL', 'PHI', 'PHO', 'MEM', 'LAC', 'SAC', 'OKC', 'IND', 'SA']
			if 'opposing_defense_PA' in [feature[0] for feature in features]: #Ian: put 2012/2013/2014 seasons in database
				# self.defense_season_avgs={season:{team:self.opposing_defense_stats(team,season) for team in self.teams} for season in self.seasons.keys()} 
				self.defense_season_avgs={'2015': {'MIL': {'BSG': 13.00625, 'BC': 14.353846153846153, 'BPG': 15.290624999999999, 'BPF': 13.897685185185184, 'SC': 21.176470588235293, 'SSG': 20.45333333333333, 'SSF': 28.92685185185185, 'BSF': 10.152222222222223, 'SPF': 24.75333333333333, 'SPG': 24.877777777777776}, 'MIN': {'BSG': 13.095833333333335, 'BC': 13.442857142857141, 'BPG': 12.832142857142856, 'BPF': 12.75654761904762, 'SC': 28.839999999999996, 'SSG': 18.319999999999997, 'SSF': 23.357692307692307, 'BSF': 12.8125, 'SPF': 25.339285714285715, 'SPG': 33.637499999999996}, 'MIA': {'BSG': 13.117857142857142, 'BC': 10.465384615384616, 'BPG': 11.75, 'BPF': 10.81904761904762, 'SC': 23.421428571428571, 'SSG': 17.542307692307691, 'SSF': 26.723076923076921, 'BSF': 9.2763888888888886, 'SPF': 26.039285714285715, 'SPG': 23.387500000000003}, 'ATL': {'BSG': 13.858333333333333, 'BC': 9.9343750000000011, 'BPG': 15.321052631578945, 'BPF': 13.742499999999998, 'SC': 29.057894736842105, 'SSG': 20.37777777777778, 'SSF': 25.664912280701753, 'BSF': 8.4142857142857146, 'SPF': 29.474999999999998, 'SPG': 28.123684210526317}, 'BOS': {'BSG': 12.25111111111111, 'BC': 11.580000000000002, 'BPG': 12.345555555555556, 'BPF': 9.8057291666666675, 'SC': 28.132352941176471, 'SSG': 25.425000000000001, 'SSF': 26.321428571428566, 'BSF': 11.125, 'SPF': 25.938461538461539, 'SPG': 24.06666666666667}, 'DET': {'BSG': 9.7558823529411764, 'BC': 11.459999999999999, 'BPG': 16.363333333333333, 'BPF': 10.604166666666668, 'SC': 24.961764705882352, 'SSG': 22.583333333333336, 'SSF': 25.0, 'BSF': 9.4866666666666681, 'SPF': 30.039999999999999, 'SPG': 27.444117647058821}, 'DEN': {'BSG': 10.959895833333331, 'BC': 9.5875000000000004, 'BPG': 14.867708333333335, 'BPF': 14.776851851851852, 'SC': 29.769444444444439, 'SSG': 26.49642857142857, 'SSF': 23.969444444444445, 'BSF': 8.7935185185185176, 'SPF': 21.316666666666666, 'SPG': 29.155263157894741}, 'NO': {'BSG': 10.889215686274509, 'BC': 11.489999999999998, 'BPG': 14.330555555555557, 'BPF': 13.423437500000002, 'SC': 25.568750000000001, 'SSG': 24.884374999999999, 'SSF': 23.546875, 'BSF': 9.9312499999999986, 'SPF': 27.606666666666666, 'SPG': 35.268421052631574}, 'DAL': {'BSG': 14.09313725490196, 'BC': 8.1363636363636385, 'BPG': 11.769791666666666, 'BPF': 14.718627450980392, 'SC': 22.905263157894737, 'SSG': 19.235714285714288, 'SSF': 20.16078431372549, 'BSF': 10.267647058823529, 'SPF': 30.616666666666667, 'SPG': 29.57368421052632}, 'BKN': {'BSG': 11.734444444444444, 'BC': 15.789285714285711, 'BPG': 13.799999999999999, 'BPF': 8.6466666666666665, 'SC': 27.926666666666669, 'SSG': 23.858333333333334, 'SSF': 26.669230769230769, 'BSF': 9.2049999999999983, 'SPF': 25.889285714285716, 'SPG': 31.269444444444446}, 'POR': {'BSG': 15.547619047619049, 'BC': 15.619999999999999, 'BPG': 11.049999999999999, 'BPF': 12.511111111111111, 'SC': 33.0, 'SSG': 24.532142857142855, 'SSF': 18.774999999999999, 'BSF': 10.352941176470589, 'SPF': 27.313157894736843, 'SPG': 29.091666666666665}, 'OKC': {'BSG': 10.224358974358974, 'BC': 15.758333333333331, 'BPG': 14.650925925925925, 'BPF': 12.729629629629629, 'SC': 29.420000000000002, 'SSG': 26.578571428571429, 'SSF': 23.662500000000001, 'BSF': 10.170833333333333, 'SPF': 24.533333333333335, 'SPG': 27.763888888888889}, 'TOR': {'BSG': 10.562222222222223, 'BC': 14.061111111111112, 'BPG': 16.427777777777781, 'BPF': 10.194791666666667, 'SC': 24.936842105263157, 'SSG': 21.206666666666663, 'SSF': 25.336111111111112, 'BSF': 9.2714285714285722, 'SPF': 28.3923076923077, 'SPG': 27.935294117647064}, 'CHI': {'BSG': 8.2166666666666668, 'BC': 19.268181818181816, 'BPG': 10.025000000000002, 'BPF': 15.281666666666666, 'SC': 29.231249999999999, 'SSG': 23.025000000000002, 'SSF': 26.931111111111115, 'BSF': 8.1916666666666682, 'SPF': 23.263636363636365, 'SPG': 31.971874999999997}, 'NY': {'BSG': 11.630392156862746, 'BC': 10.4125, 'BPG': 13.546428571428574, 'BPF': 13.451754385964913, 'SC': 26.387499999999996, 'SSG': 24.017857142857139, 'SSF': 25.320238095238093, 'BSF': 10.125, 'SPF': 24.068749999999998, 'SPG': 28.882352941176471}, 'CHA': {'BSG': 10.074444444444445, 'BC': 16.256249999999998, 'BPG': 12.444117647058825, 'BPF': 13.733333333333333, 'SC': 24.440000000000001, 'SSG': 23.658333333333331, 'SSF': 25.228571428571431, 'BSF': 10.329166666666666, 'SPF': 28.73, 'SPG': 28.105882352941176}, 'UTA': {'BSG': 12.040909090909089, 'BC': 11.366666666666667, 'BPG': 10.115384615384615, 'BPF': 7.6600000000000001, 'SC': 25.406666666666663, 'SSG': 15.07, 'SSF': 26.549999999999997, 'BSF': 8.2166666666666668, 'SPF': 31.263333333333332, 'SPG': 31.146666666666668}, 'GS': {'BSG': 11.247777777777776, 'BC': 12.595833333333331, 'BPG': 13.509375, 'BPF': 12.001851851851852, 'SC': 25.56111111111111, 'SSG': 25.058333333333337, 'SSF': 19.060000000000002, 'BSF': 12.316666666666665, 'SPF': 24.050000000000001, 'SPG': 28.352631578947371}, 'CLE': {'BSG': 12.54871794871795, 'BC': 6.379999999999999, 'BPG': 14.947058823529412, 'BPF': 8.6768518518518505, 'SC': 28.181249999999999, 'SSG': 23.670588235294122, 'SSF': 23.440625000000001, 'BSF': 5.9727272727272727, 'SPF': 29.458333333333332, 'SPG': 26.294117647058819}, 'HOU': {'BSG': 12.888888888888888, 'BC': 17.927272727272726, 'BPG': 14.411403508771933, 'BPF': 10.111458333333333, 'SC': 26.447058823529417, 'SSG': 20.800000000000001, 'SSF': 26.021568627450986, 'BSF': 15.023076923076921, 'SPF': 32.211538461538467, 'SPG': 30.518749999999997}, 'WAS': {'BSG': 14.072727272727274, 'BC': 11.691666666666668, 'BPG': 11.436666666666666, 'BPF': 12.172222222222221, 'SC': 23.74642857142857, 'SSG': 23.199999999999999, 'SSF': 31.564285714285713, 'BSF': 9.8045454545454547, 'SPF': 24.862500000000001, 'SPG': 28.715624999999999}, 'LAL': {'BSG': 10.86153846153846, 'BC': 14.627777777777775, 'BPG': 14.833333333333334, 'BPF': 13.69351851851852, 'SC': 29.347058823529409, 'SSG': 18.879999999999995, 'SSF': 24.928431372549017, 'BSF': 10.496153846153845, 'SPF': 22.349999999999998, 'SPG': 36.864705882352943}, 'PHI': {'BSG': 9.6149122807017537, 'BC': 15.023611111111109, 'BPG': 11.785294117647059, 'BPF': 10.149999999999999, 'SC': 27.131578947368421, 'SSG': 21.689285714285717, 'SSF': 28.899999999999999, 'BSF': 10.962499999999999, 'SPF': 30.682352941176465, 'SPG': 28.086842105263155}, 'PHO': {'BSG': 11.460256410256411, 'BC': 12.563636363636363, 'BPG': 13.196874999999999, 'BPF': 10.555555555555554, 'SC': 20.694444444444443, 'SSG': 23.366666666666667, 'SSF': 25.318749999999994, 'BSF': 11.429166666666667, 'SPF': 26.711111111111112, 'SPG': 33.150000000000006}, 'MEM': {'BSG': 12.828070175438594, 'BC': 9.6863636363636374, 'BPG': 14.253125000000001, 'BPF': 8.8088235294117663, 'SC': 24.297368421052635, 'SSG': 22.005555555555556, 'SSF': 23.460526315789469, 'BSF': 10.813333333333333, 'SPF': 30.433333333333337, 'SPG': 28.432352941176468}, 'LAC': {'BSG': 9.0555555555555554, 'BC': 13.161538461538461, 'BPG': 13.002941176470589, 'BPF': 10.403333333333332, 'SC': 27.755555555555556, 'SSG': 23.38529411764706, 'SSF': 28.646666666666661, 'BSF': 9.071568627450981, 'SPF': 21.749999999999996, 'SPG': 28.121052631578944}, 'SAC': {'BSG': 12.136458333333334, 'BC': 10.531818181818181, 'BPG': 16.839999999999996, 'BPF': 11.890740740740743, 'SC': 26.52105263157895, 'SSG': 24.555882352941179, 'SSF': 23.557692307692307, 'BSF': 10.948717948717947, 'SPF': 30.442857142857143, 'SPG': 31.286111111111111}, 'ORL': {'BSG': 10.721428571428573, 'BC': 15.666666666666666, 'BPG': 16.225000000000001, 'BPF': 13.072916666666666, 'SC': 26.668749999999999, 'SSG': 24.693750000000001, 'SSF': 28.481249999999999, 'BSF': 9.0285714285714285, 'SPF': 25.621874999999999, 'SPG': 30.076470588235299}, 'IND': {'BSG': 9.4961538461538453, 'BC': 11.955, 'BPG': 11.069230769230767, 'BPF': 13.47111111111111, 'SC': 30.026666666666664, 'SSG': 24.560714285714287, 'SSF': 19.334615384615386, 'BSF': 11.065384615384614, 'SPF': 20.913333333333334, 'SPG': 25.509374999999999}, 'SA': {'BSG': 7.590196078431374, 'BC': 17.083333333333332, 'BPG': 14.75625, 'BPF': 11.80625, 'SC': 19.716666666666669, 'SSG': 14.823529411764707, 'SSF': 20.047058823529408, 'BSF': 13.054166666666667, 'SPF': 23.993750000000002, 'SPG': 27.71052631578948}}, '2014': {'MIL': {'BSG': 11.627513227513226, 'BC': 11.011458333333332, 'BPG': 13.637313432835821, 'BPF': 14.222602739726028, 'SC': 26.039999999999999, 'SSG': 24.373333333333331, 'SSF': 25.947222222222219, 'BSF': 11.665454545454548, 'SPF': 26.145384615384614, 'SPG': 26.932432432432435}, 'MIN': {'BSG': 11.912189054726367, 'BC': 11.973270440251573, 'BPG': 14.527114427860697, 'BPF': 14.437009803921567, 'SC': 28.067123287671233, 'SSG': 24.556531531531533, 'SSF': 25.162162162162161, 'BSF': 10.355790960451978, 'SPF': 27.80220588235294, 'SPG': 31.37260273972603}, 'MIA': {'BSG': 11.376470588235293, 'BC': 13.393220338983051, 'BPG': 13.527777777777779, 'BPF': 13.596614583333334, 'SC': 26.480666666666664, 'SSG': 23.205072463768118, 'SSF': 23.275870646766172, 'BSF': 9.7764705882352949, 'SPF': 22.37230392156863, 'SPG': 28.850649350649345}, 'ATL': {'BSG': 13.408935185185186, 'BC': 12.434000000000001, 'BPG': 12.928873239436621, 'BPF': 12.53857142857143, 'SC': 26.27112676056338, 'SSG': 22.521527777777777, 'SSF': 22.63564814814815, 'BSF': 10.281896551724136, 'SPF': 25.718627450980392, 'SPG': 29.426623376623375}, 'BOS': {'BSG': 13.664303482587064, 'BC': 11.565079365079365, 'BPG': 13.674358974358976, 'BPF': 13.720119047619047, 'SC': 29.156338028169014, 'SSG': 22.469047619047622, 'SSF': 22.822463768115938, 'BSF': 12.725, 'SPF': 27.735074626865671, 'SPG': 31.318918918918918}, 'DET': {'BSG': 13.196785714285713, 'BC': 12.450999999999999, 'BPG': 13.338028169014086, 'BPF': 13.306159420289857, 'SC': 29.71233766233766, 'SSG': 25.539351851851855, 'SSF': 22.850000000000001, 'BSF': 10.308024691358026, 'SPF': 27.216438356164382, 'SPG': 26.266666666666666}, 'DEN': {'BSG': 13.462380952380952, 'BC': 13.685034013605444, 'BPG': 12.4078125, 'BPF': 13.973774509803922, 'SC': 27.339041095890412, 'SSG': 25.462318840579709, 'SSF': 25.360045662100458, 'BSF': 12.3448087431694, 'SPF': 28.786428571428569, 'SPG': 29.148000000000003}, 'NO': {'BSG': 13.139975845410628, 'BC': 13.293537414965984, 'BPG': 13.802619047619048, 'BPF': 11.00199530516432, 'SC': 27.580821917808219, 'SSG': 21.421739130434784, 'SSF': 25.054222222222226, 'BSF': 10.73179012345679, 'SPF': 27.077294685990339, 'SPG': 30.140909090909091}, 'DAL': {'BSG': 12.356924882629109, 'BC': 11.81045751633987, 'BPG': 13.470476190476189, 'BPF': 12.773913043478261, 'SC': 26.941666666666666, 'SSG': 24.113470319634708, 'SSF': 23.819953051643193, 'BSF': 10.685119047619049, 'SPF': 26.904427083333335, 'SPG': 30.757236842105261}, 'BKN': {'BSG': 12.823958333333334, 'BC': 12.345454545454547, 'BPG': 13.964898989898989, 'BPF': 14.549637681159421, 'SC': 27.475000000000001, 'SSG': 25.736854460093898, 'SSF': 24.705072463768115, 'BSF': 11.589062500000001, 'SPF': 26.072463768115941, 'SPG': 28.437012987012988}, 'POR': {'BSG': 13.540573770491804, 'BC': 11.746258503401362, 'BPG': 12.031025641025641, 'BPF': 10.36497584541063, 'SC': 27.052142857142858, 'SSG': 24.763194444444441, 'SSF': 23.255882352941178, 'BSF': 11.451572327044024, 'SPF': 25.609389671361505, 'SPG': 34.127272727272725}, 'OKC': {'BSG': 11.403282828282828, 'BC': 12.084591194968553, 'BPG': 12.768627450980393, 'BPF': 16.290740740740738, 'SC': 25.074999999999999, 'SSG': 24.45808823529412, 'SSF': 24.747916666666669, 'BSF': 9.3513157894736842, 'SPF': 27.377857142857142, 'SPG': 30.631818181818176}, 'TOR': {'BSG': 10.211410256410257, 'BC': 13.505000000000001, 'BPG': 12.790714285714285, 'BPF': 12.332850241545893, 'SC': 25.97337662337662, 'SSG': 26.531592039800998, 'SSF': 24.659589041095888, 'BSF': 11.703846153846154, 'SPF': 25.984722222222221, 'SPG': 31.961333333333332}, 'CHI': {'BSG': 10.895641025641027, 'BC': 12.968, 'BPG': 13.508333333333335, 'BPF': 13.136428571428571, 'SC': 26.510624999999997, 'SSG': 24.471621621621619, 'SSF': 24.819594594594594, 'BSF': 9.5393790849673206, 'SPF': 26.276712328767125, 'SPG': 31.726282051282052}, 'NY': {'BSG': 11.813732394366196, 'BC': 11.074999999999999, 'BPG': 13.815671641791047, 'BPF': 12.04662162162162, 'SC': 28.835714285714285, 'SSG': 25.0, 'SSF': 23.539705882352941, 'BSF': 9.5660714285714281, 'SPF': 24.876940639269403, 'SPG': 30.388750000000005}, 'CHA': {'BSG': 13.861846153846153, 'BC': 11.458928571428572, 'BPG': 14.240931372549019, 'BPF': 14.32294685990338, 'SC': 25.737333333333336, 'SSG': 23.537671232876711, 'SSF': 20.858095238095242, 'BSF': 10.026543209876545, 'SPF': 26.886805555555554, 'SPG': 28.800000000000001}, 'UTA': {'BSG': 13.259343434343435, 'BC': 11.646258503401359, 'BPG': 12.888732394366198, 'BPF': 12.266425120772945, 'SC': 23.71619718309859, 'SSG': 20.928985507246374, 'SSF': 21.803828828828831, 'BSF': 11.289000000000001, 'SPF': 26.135820895522389, 'SPG': 27.848076923076931}, 'GS': {'BSG': 12.088059701492535, 'BC': 12.54903846153846, 'BPG': 14.549761904761903, 'BPF': 12.027272727272727, 'SC': 25.883561643835616, 'SSG': 21.256428571428568, 'SSF': 23.338584474885849, 'BSF': 11.449348958333333, 'SPF': 25.978743961352659, 'SPG': 28.285526315789472}, 'CLE': {'BSG': 13.13270202020202, 'BC': 11.710000000000001, 'BPG': 12.525476190476191, 'BPF': 12.62716894977169, 'SC': 27.87808219178082, 'SSG': 23.869117647058822, 'SSF': 24.703240740740739, 'BSF': 10.403267973856209, 'SPF': 24.583582089552237, 'SPG': 28.541772151898737}, 'HOU': {'BSG': 12.900781250000001, 'BC': 14.335416666666667, 'BPG': 12.507746478873241, 'BPF': 13.213470319634704, 'SC': 27.655555555555551, 'SSG': 23.680701754385964, 'SSF': 23.818656716417912, 'BSF': 10.786666666666667, 'SPF': 28.218461538461536, 'SPG': 29.075333333333329}, 'WAS': {'BSG': 11.345833333333333, 'BC': 12.654999999999999, 'BPG': 15.509203980099505, 'BPF': 13.518243243243242, 'SC': 23.727922077922077, 'SSG': 21.853333333333335, 'SSF': 21.967123287671235, 'BSF': 10.03169934640523, 'SPF': 23.120714285714278, 'SPG': 29.201948051948055}, 'LAL': {'BSG': 12.602261904761905, 'BC': 12.691319444444446, 'BPG': 14.686029411764705, 'BPF': 12.516666666666667, 'SC': 28.870547945205477, 'SSG': 25.556164383561644, 'SSF': 24.998529411764704, 'BSF': 10.243749999999999, 'SPF': 27.932857142857141, 'SPG': 32.922727272727272}, 'PHI': {'BSG': 14.470126262626261, 'BC': 11.790384615384614, 'BPG': 16.702450980392157, 'BPF': 14.538725490196079, 'SC': 29.947857142857142, 'SSG': 22.043055555555551, 'SSF': 24.084782608695654, 'BSF': 9.8301282051282044, 'SPF': 24.833802816901407, 'SPG': 29.475333333333328}, 'PHO': {'BSG': 12.148188405797102, 'BC': 15.659666666666666, 'BPG': 13.528819444444444, 'BPF': 12.312189054726369, 'SC': 25.788, 'SSG': 24.647777777777776, 'SSF': 24.082207207207208, 'BSF': 11.256060606060604, 'SPF': 25.480597014925369, 'SPG': 30.593999999999998}, 'MEM': {'BSG': 11.755134408602151, 'BC': 11.122916666666669, 'BPG': 13.067929292929295, 'BPF': 11.339814814814815, 'SC': 23.835333333333331, 'SSG': 23.847368421052632, 'SSF': 23.236231884057968, 'BSF': 10.398809523809524, 'SPF': 23.445774647887323, 'SPG': 30.673333333333332}, 'LAC': {'BSG': 12.420710784313727, 'BC': 13.680225988700565, 'BPG': 14.191044776119403, 'BPF': 13.792051282051283, 'SC': 24.582835820895522, 'SSG': 22.924657534246574, 'SSF': 26.161971830985916, 'BSF': 9.6453869047619047, 'SPF': 25.639436619718307, 'SPG': 25.343333333333334}, 'SAC': {'BSG': 12.205128205128204, 'BC': 14.324183006535947, 'BPG': 13.659068627450981, 'BPF': 14.540972222222223, 'SC': 25.330405405405408, 'SSG': 27.137387387387392, 'SSF': 25.456280193236712, 'BSF': 10.96219135802469, 'SPF': 27.972857142857137, 'SPG': 32.030821917808218}, 'ORL': {'BSG': 13.299242424242426, 'BC': 14.027884615384616, 'BPG': 14.337999999999999, 'BPF': 13.576119402985075, 'SC': 26.983552631578949, 'SSG': 23.611428571428572, 'SSF': 24.285416666666663, 'BSF': 10.591525423728813, 'SPF': 27.493095238095236, 'SPG': 29.543421052631583}, 'IND': {'BSG': 11.768308080808081, 'BC': 12.030503144654087, 'BPG': 12.324603174603176, 'BPF': 12.642447916666667, 'SC': 27.648026315789473, 'SSG': 24.383333333333333, 'SSF': 21.476851851851855, 'BSF': 11.133030303030301, 'SPF': 25.237837837837837, 'SPG': 30.640000000000001}, 'SA': {'BSG': 10.202860696517412, 'BC': 11.557666666666664, 'BPG': 14.093382352941177, 'BPF': 12.479223744292236, 'SC': 26.899999999999995, 'SSG': 22.607107843137257, 'SSF': 20.816911764705882, 'BSF': 10.013055555555555, 'SPF': 28.87028985507246, 'SPG': 30.622368421052634}}, '2013': {'MIL': {'BSG': 11.585593220338982, 'BC': 11.574545454545452, 'BPG': 12.822705314009662, 'BPF': 13.694191919191923, 'SC': 29.316153846153842, 'SSG': 25.743076923076924, 'SSF': 25.231904761904762, 'BSF': 10.592231638418079, 'SPF': 28.957487922705312, 'SPG': 28.032716049382717}, 'MIN': {'BSG': 11.642888888888889, 'BC': 11.750303030303032, 'BPG': 12.429555555555556, 'BPF': 13.3987922705314, 'SC': 25.154545454545456, 'SSG': 24.991379310344829, 'SSF': 26.259343434343435, 'BSF': 12.950273224043714, 'SPF': 26.153731343283582, 'SPG': 30.577499999999997}, 'MIA': {'BSG': 11.545128205128206, 'BC': 9.25701754385965, 'BPG': 11.536923076923076, 'BPF': 13.575373134328359, 'SC': 27.782575757575753, 'SSG': 23.423484848484854, 'SSF': 23.388235294117646, 'BSF': 9.217948717948719, 'SPF': 27.473697916666666, 'SPG': 26.63841463414634}, 'ATL': {'BSG': 12.200245098039218, 'BC': 12.533333333333335, 'BPG': 14.757619047619047, 'BPF': 13.014102564102563, 'SC': 26.779545454545456, 'SSG': 23.156878306878308, 'SSF': 26.102645502645505, 'BSF': 10.382156862745099, 'SPF': 28.547303921568624, 'SPG': 28.72278481012658}, 'BOS': {'BSG': 11.897311827956988, 'BC': 11.444545454545453, 'BPG': 13.464840182648402, 'BPF': 13.703787878787878, 'SC': 28.615322580645159, 'SSG': 24.732575757575759, 'SSF': 24.708461538461535, 'BSF': 9.9333333333333336, 'SPF': 29.176119402985073, 'SPG': 27.315625000000001}, 'DET': {'BSG': 13.860606060606061, 'BC': 11.615686274509804, 'BPG': 13.321641791044778, 'BPF': 12.864676616915423, 'SC': 28.803174603174604, 'SSG': 25.790000000000003, 'SSF': 25.675781250000004, 'BSF': 11.579910714285717, 'SPF': 27.104106280193236, 'SPG': 29.077160493827154}, 'DEN': {'BSG': 12.536384976525822, 'BC': 10.100961538461537, 'BPG': 12.610386473429951, 'BPF': 13.980913978494623, 'SC': 28.634848484848483, 'SSG': 25.020491803278688, 'SSF': 24.907960199004975, 'BSF': 10.550268817204303, 'SPF': 33.748067632850237, 'SPG': 30.833333333333332}, 'NO': {'BSG': 11.089054726368159, 'BC': 7.8585106382978731, 'BPG': 12.393287037037036, 'BPF': 14.607720588235294, 'SC': 27.239843750000002, 'SSG': 24.240677966101693, 'SSF': 26.159859154929581, 'BSF': 10.212146892655369, 'SPF': 29.464285714285715, 'SPG': 30.409876543209876}, 'DAL': {'BSG': 9.6902777777777782, 'BC': 9.2851851851851865, 'BPG': 12.819565217391306, 'BPF': 11.851912568306009, 'SC': 26.98030303030303, 'SSG': 24.1796875, 'SSF': 26.695945945945947, 'BSF': 11.254885057471263, 'SPF': 30.471904761904756, 'SPG': 29.329374999999992}, 'BKN': {'BSG': 12.305, 'BC': 11.434353741496597, 'BPG': 12.725925925925926, 'BPF': 14.141931216931216, 'SC': 24.911194029850748, 'SSG': 23.426190476190477, 'SSF': 23.847058823529409, 'BSF': 10.676785714285714, 'SPF': 24.991666666666667, 'SPG': 26.947499999999998}, 'POR': {'BSG': 13.238732394366199, 'BC': 10.165384615384616, 'BPG': 13.561194029850745, 'BPF': 12.151111111111112, 'SC': 27.380597014925371, 'SSG': 25.674545454545452, 'SSF': 23.082835820895522, 'BSF': 10.949152542372881, 'SPF': 26.658208955223888, 'SPG': 31.964999999999996}, 'OKC': {'BSG': 11.837810945273629, 'BC': 8.8227272727272723, 'BPG': 11.527179487179486, 'BPF': 12.710026041666667, 'SC': 25.34375, 'SSG': 27.463636363636361, 'SSF': 22.58308823529412, 'BSF': 10.069907407407406, 'SPF': 29.942929292929293, 'SPG': 28.507499999999993}, 'TOR': {'BSG': 10.939646464646465, 'BC': 10.28611111111111, 'BPG': 11.581794871794873, 'BPF': 11.607835820895522, 'SC': 25.746031746031747, 'SSG': 24.24126984126984, 'SSF': 26.738095238095234, 'BSF': 11.675000000000001, 'SPF': 26.134068627450979, 'SPG': 26.754375000000003}, 'CHI': {'BSG': 11.286519607843138, 'BC': 10.879696969696969, 'BPG': 11.072535211267605, 'BPF': 13.125, 'SC': 25.299193548387095, 'SSG': 21.28560606060606, 'SSF': 22.357575757575759, 'BSF': 9.319642857142858, 'SPF': 26.750245098039212, 'SPG': 28.281481481481485}, 'NY': {'BSG': 10.637878787878789, 'BC': 9.3016025641025646, 'BPG': 11.794761904761906, 'BPF': 10.765422885572141, 'SC': 27.527118644067794, 'SSG': 26.38384615384615, 'SSF': 25.549253731343285, 'BSF': 10.042486338797815, 'SPF': 22.528985507246379, 'SPG': 28.105487804878049}, 'CHA': {'BSG': 11.834615384615384, 'BC': 10.065254237288134, 'BPG': 13.128240740740742, 'BPF': 12.674253731343283, 'SC': 25.391525423728812, 'SSG': 22.365897435897434, 'SSF': 22.650980392156864, 'BSF': 10.58418300653595, 'SPF': 27.816931216931216, 'SPG': 28.312658227848104}, 'UTA': {'BSG': 12.174494949494948, 'BC': 10.428947368421053, 'BPG': 13.162121212121212, 'BPF': 11.455208333333335, 'SC': 27.826515151515146, 'SSG': 23.53303571428572, 'SSF': 23.470454545454547, 'BSF': 11.516506410256408, 'SPF': 30.837499999999999, 'SPG': 29.322499999999998}, 'GS': {'BSG': 13.535897435897436, 'BC': 10.891156462585036, 'BPG': 13.812745098039214, 'BPF': 13.532010582010583, 'SC': 27.711904761904766, 'SSG': 23.489090909090908, 'SSF': 23.155714285714286, 'BSF': 11.012654320987654, 'SPF': 29.593661971830986, 'SPG': 27.415624999999999}, 'CLE': {'BSG': 12.504545454545458, 'BC': 9.4928571428571438, 'BPG': 12.338967136150234, 'BPF': 13.544907407407409, 'SC': 25.957142857142856, 'SSG': 25.229365079365081, 'SSF': 27.783578431372547, 'BSF': 10.152287581699346, 'SPF': 29.418137254901957, 'SPG': 32.948148148148142}, 'HOU': {'BSG': 12.971969696969696, 'BC': 8.7997076023391809, 'BPG': 13.483333333333331, 'BPF': 13.229545454545455, 'SC': 25.318115942028985, 'SSG': 26.302459016393438, 'SSF': 25.717892156862746, 'BSF': 8.8823728813559324, 'SPF': 30.446153846153845, 'SPG': 28.072784810126581}, 'WAS': {'BSG': 12.022307692307693, 'BC': 11.187820512820512, 'BPG': 12.671759259259261, 'BPF': 11.623655913978496, 'SC': 26.014084507042252, 'SSG': 23.71290322580645, 'SSF': 23.409701492537312, 'BSF': 11.801250000000001, 'SPF': 27.372388059701493, 'SPG': 28.916666666666668}, 'LAL': {'BSG': 11.08, 'BC': 10.925892857142856, 'BPG': 13.314285714285715, 'BPF': 14.823358585858585, 'SC': 30.851470588235287, 'SSG': 29.102499999999999, 'SSF': 27.132107843137252, 'BSF': 13.960909090909091, 'SPF': 32.348232323232324, 'SPG': 32.269999999999996}, 'PHI': {'BSG': 13.101344086021506, 'BC': 11.878301886792451, 'BPG': 14.75855855855856, 'BPF': 14.425870646766169, 'SC': 32.637500000000003, 'SSG': 27.066666666666663, 'SSF': 28.413970588235294, 'BSF': 10.069135802469136, 'SPF': 30.620000000000001, 'SPG': 29.970121951219507}, 'PHO': {'BSG': 11.649180327868851, 'BC': 8.7476190476190485, 'BPG': 13.090625000000001, 'BPF': 13.018079096045197, 'SC': 26.377049180327869, 'SSG': 23.377586206896549, 'SSF': 24.497380952380951, 'BSF': 12.070903954802262, 'SPF': 28.127934272300465, 'SPG': 29.051874999999995}, 'MEM': {'BSG': 12.235024154589373, 'BC': 10.969791666666666, 'BPG': 12.008454106280194, 'BPF': 12.032682291666667, 'SC': 22.768461538461541, 'SSG': 22.035875706214686, 'SSF': 23.253623188405797, 'BSF': 8.8184259259259239, 'SPF': 28.215897435897435, 'SPG': 26.801250000000003}, 'LAC': {'BSG': 11.244791666666666, 'BC': 13.982291666666667, 'BPG': 12.298756218905474, 'BPF': 12.571428571428571, 'SC': 28.219999999999999, 'SSG': 24.172131147540984, 'SSF': 24.161827956989246, 'BSF': 11.622267759562842, 'SPF': 28.774999999999999, 'SPG': 24.672839506172838}, 'SAC': {'BSG': 13.31640625, 'BC': 9.3894736842105271, 'BPG': 14.436567164179104, 'BPF': 12.836549707602341, 'SC': 27.492753623188406, 'SSG': 25.145967741935483, 'SSF': 24.57164179104478, 'BSF': 12.59878787878788, 'SPF': 29.915686274509802, 'SPG': 28.485390946502058}, 'ORL': {'BSG': 12.146031746031747, 'BC': 9.5267241379310335, 'BPG': 12.683802816901409, 'BPF': 13.095772946859904, 'SC': 28.362500000000001, 'SSG': 25.65948275862069, 'SSF': 26.076570048309179, 'BSF': 12.088194444444445, 'SPF': 29.238636363636363, 'SPG': 28.933749999999996}, 'IND': {'BSG': 10.443478260869565, 'BC': 9.8054487179487175, 'BPG': 11.270601851851852, 'BPF': 12.369010416666667, 'SC': 25.86461538461538, 'SSG': 22.920634920634921, 'SSF': 23.711194029850748, 'BSF': 8.5677272727272733, 'SPF': 24.092488262910798, 'SPG': 27.994936708860759}, 'SA': {'BSG': 10.920714285714286, 'BC': 10.881355932203389, 'BPG': 12.824429223744293, 'BPF': 12.355555555555556, 'SC': 25.556818181818183, 'SSG': 22.46846153846154, 'SSF': 22.774999999999999, 'BSF': 9.4635802469135815, 'SPF': 29.474358974358974, 'SPG': 28.083333333333332}}, '2012': {'MIL': {'BSG': 11.23939393939394, 'BC': 14.225555555555555, 'BPG': 12.717123287671233, 'BPF': 14.597222222222221, 'SC': 30.899193548387093, 'SSG': 22.920967741935481, 'SSF': 27.936805555555551, 'BSF': 10.615454545454545, 'SPF': 26.233597883597884, 'SPG': 28.759583333333332}, 'MIN': {'BSG': 12.853385416666669, 'BC': 10.075555555555555, 'BPG': 12.521666666666668, 'BPF': 13.222149122807018, 'SC': 25.899999999999999, 'SSG': 23.890983606557381, 'SSF': 24.076119402985075, 'BSF': 10.83187134502924, 'SPF': 24.61129032258064, 'SPG': 30.328806584362137}, 'MIA': {'BSG': 13.228855721393034, 'BC': 10.314473684210526, 'BPG': 12.455821917808219, 'BPF': 10.560798122065728, 'SC': 24.964179104477616, 'SSG': 20.775781250000001, 'SSF': 26.009420289855075, 'BSF': 10.257142857142856, 'SPF': 25.249702380952378, 'SPG': 25.568124999999998}, 'ATL': {'BSG': 14.679232804232802, 'BC': 11.678571428571429, 'BPG': 13.211428571428572, 'BPF': 12.445539906103289, 'SC': 25.846212121212115, 'SSG': 21.933333333333337, 'SSF': 24.611111111111111, 'BSF': 11.818787878787878, 'SPF': 27.149122807017545, 'SPG': 28.154732510288067}, 'BOS': {'BSG': 11.852238805970147, 'BC': 11.539772727272727, 'BPG': 12.511428571428574, 'BPF': 13.830769230769231, 'SC': 26.025833333333335, 'SSG': 21.650757575757574, 'SSF': 28.075362318840575, 'BSF': 10.127222222222223, 'SPF': 25.071236559139788, 'SPG': 27.673456790123453}, 'DET': {'BSG': 12.672222222222221, 'BC': 12.046938775510203, 'BPG': 12.719634703196348, 'BPF': 13.016666666666667, 'SC': 28.52391304347826, 'SSG': 24.21160714285714, 'SSF': 25.020422535211267, 'BSF': 11.792241379310346, 'SPF': 24.452956989247312, 'SPG': 28.625720164609049}, 'DEN': {'BSG': 15.081250000000001, 'BC': 12.773504273504273, 'BPG': 13.454824561403511, 'BPF': 14.249134199134197, 'SC': 27.938805970149247, 'SSG': 23.558181818181819, 'SSF': 24.159661835748789, 'BSF': 11.002499999999998, 'SPF': 27.051225490196074, 'SPG': 27.749390243902443}, 'NO': {'BSG': 14.830208333333335, 'BC': 9.0732142857142861, 'BPG': 12.94391891891892, 'BPF': 11.892888888888889, 'SC': 26.798437499999999, 'SSG': 23.567241379310346, 'SSF': 25.636764705882353, 'BSF': 11.867896174863388, 'SPF': 24.743034825870645, 'SPG': 28.845625000000002}, 'DAL': {'BSG': 12.811442786069652, 'BC': 10.517021276595745, 'BPG': 12.134018264840183, 'BPF': 11.340692640692641, 'SC': 27.435384615384613, 'SSG': 24.577499999999997, 'SSF': 27.424657534246577, 'BSF': 11.204970760233918, 'SPF': 27.230687830687835, 'SPG': 29.48875}, 'BKN': {'BSG': 11.888709677419357, 'BC': 6.8467391304347824, 'BPG': 10.897945205479452, 'BPF': 10.558450704225352, 'SC': 27.944615384615386, 'SSG': 21.43137254901961, 'SSF': 25.608706467661687, 'BSF': 10.711527777777778, 'SPF': 24.655367231638415, 'SPG': 28.76103896103896}, 'POR': {'BSG': 14.902553763440858, 'BC': 10.333018867924528, 'BPG': 12.190000000000001, 'BPF': 15.399305555555559, 'SC': 28.01985294117647, 'SSG': 24.32377049180328, 'SSF': 24.773015873015868, 'BSF': 11.056410256410258, 'SPF': 27.441282051282048, 'SPG': 29.075925925925926}, 'OKC': {'BSG': 12.412021857923497, 'BC': 11.34021739130435, 'BPG': 12.292792792792792, 'BPF': 13.381038647342995, 'SC': 26.007142857142856, 'SSG': 21.265322580645158, 'SSF': 22.241666666666667, 'BSF': 10.18015873015873, 'SPF': 25.385714285714286, 'SPG': 26.34135802469136}, 'TOR': {'BSG': 12.936956521739129, 'BC': 10.941304347826087, 'BPG': 12.36737089201878, 'BPF': 13.308333333333335, 'SC': 29.271774193548385, 'SSG': 22.666935483870969, 'SSF': 25.368382352941175, 'BSF': 10.645454545454545, 'SPF': 25.566931216931216, 'SPG': 27.882113821138208}, 'CHI': {'BSG': 12.051515151515151, 'BC': 9.7969387755102044, 'BPG': 12.728082191780823, 'BPF': 11.188497652582159, 'SC': 27.136885245901638, 'SSG': 20.158743169398907, 'SSF': 25.685507246376812, 'BSF': 11.342452830188678, 'SPF': 24.858474576271185, 'SPG': 27.348101265822784}, 'NY': {'BSG': 12.679743589743591, 'BC': 9.067499999999999, 'BPG': 10.318981481481481, 'BPF': 10.151173708920188, 'SC': 22.87796610169492, 'SSG': 25.034946236559136, 'SSF': 25.549295774647888, 'BSF': 11.442690058479533, 'SPF': 22.3675, 'SPG': 28.824691358024694}, 'CHA': {'BSG': 13.694212962962963, 'BC': 11.989000000000001, 'BPG': 14.24611872146119, 'BPF': 12.727294685990337, 'SC': 30.042372881355931, 'SSG': 24.262295081967213, 'SSF': 28.427053140096618, 'BSF': 13.200000000000001, 'SPF': 25.740476190476191, 'SPG': 27.661585365853657}, 'UTA': {'BSG': 13.046969696969697, 'BC': 8.075490196078432, 'BPG': 11.805630630630631, 'BPF': 12.809307359307361, 'SC': 27.558333333333334, 'SSG': 21.093859649122809, 'SSF': 23.181578947368422, 'BSF': 9.3386494252873558, 'SPF': 27.435156249999999, 'SPG': 29.545121951219514}, 'GS': {'BSG': 14.553333333333336, 'BC': 11.547674418604652, 'BPG': 12.329555555555556, 'BPF': 12.279513888888891, 'SC': 25.708823529411767, 'SSG': 26.395833333333332, 'SSF': 25.70281690140845, 'BSF': 10.583035714285716, 'SPF': 29.061352657004836, 'SPG': 29.043004115226328}, 'CLE': {'BSG': 12.816183574879227, 'BC': 11.422222222222222, 'BPG': 13.165671641791047, 'BPF': 12.518981481481482, 'SC': 28.166176470588233, 'SSG': 23.637096774193548, 'SSF': 27.398095238095237, 'BSF': 11.558333333333332, 'SPF': 27.809821428571432, 'SPG': 30.140740740740743}, 'HOU': {'BSG': 13.399479166666666, 'BC': 10.993478260869566, 'BPG': 12.997685185185185, 'BPF': 13.024675324675325, 'SC': 25.536507936507935, 'SSG': 24.567575757575757, 'SSF': 24.758564814814818, 'BSF': 12.271102150537635, 'SPF': 26.955729166666668, 'SPG': 30.394375000000004}, 'WAS': {'BSG': 13.241927083333334, 'BC': 9.9858490566037741, 'BPG': 12.352380952380951, 'BPF': 12.797014925373134, 'SC': 28.919565217391309, 'SSG': 22.27410714285714, 'SSF': 25.629504504504503, 'BSF': 11.128616352201258, 'SPF': 23.159941520467836, 'SPG': 28.94227642276423}, 'LAL': {'BSG': 12.608870967741936, 'BC': 11.499107142857143, 'BPG': 13.353246753246751, 'BPF': 13.826010101010102, 'SC': 25.052307692307693, 'SSG': 25.495402298850571, 'SSF': 25.888888888888889, 'BSF': 10.902777777777779, 'SPF': 26.252564102564104, 'SPG': 33.240625000000009}, 'PHI': {'BSG': 11.664021164021165, 'BC': 11.311538461538461, 'BPG': 12.862731481481482, 'BPF': 14.38943661971831, 'SC': 29.366923076923079, 'SSG': 23.020967741935483, 'SSF': 27.050000000000001, 'BSF': 10.829781420765027, 'SPF': 25.177118644067797, 'SPG': 29.372708333333332}, 'PHO': {'BSG': 13.499739583333334, 'BC': 10.097115384615384, 'BPG': 11.653508771929825, 'BPF': 15.400483091787438, 'SC': 29.289436619718305, 'SSG': 22.872126436781613, 'SSF': 23.844927536231886, 'BSF': 9.7849726775956256, 'SPF': 26.687096774193545, 'SPG': 29.1679012345679}, 'MEM': {'BSG': 12.381967213114756, 'BC': 9.6749999999999989, 'BPG': 11.517370892018779, 'BPF': 14.151826484018267, 'SC': 22.385606060606062, 'SSG': 21.61724137931034, 'SSF': 21.643382352941178, 'BSF': 9.4666666666666686, 'SPF': 23.837626262626259, 'SPG': 25.034375000000001}, 'LAC': {'BSG': 13.440983606557376, 'BC': 8.7039215686274503, 'BPG': 10.895333333333335, 'BPF': 12.537111111111111, 'SC': 26.233088235294119, 'SSG': 24.328688524590167, 'SSF': 23.660416666666663, 'BSF': 9.560526315789474, 'SPF': 23.944531250000004, 'SPG': 24.53150406504065}, 'SAC': {'BSG': 14.910937499999999, 'BC': 12.0, 'BPG': 13.733549783549783, 'BPF': 15.222374429223745, 'SC': 26.705072463768115, 'SSG': 26.954464285714288, 'SSF': 23.514492753623191, 'BSF': 11.275956284153006, 'SPF': 28.253385416666667, 'SPG': 29.593827160493827}, 'ORL': {'BSG': 13.633946078431373, 'BC': 10.333673469387756, 'BPG': 13.317619047619047, 'BPF': 14.085384615384614, 'SC': 27.718253968253968, 'SSG': 23.719047619047618, 'SSF': 26.095588235294116, 'BSF': 10.436723163841808, 'SPF': 25.698412698412696, 'SPG': 29.081707317073167}, 'IND': {'BSG': 12.803095238095239, 'BC': 11.75, 'BPG': 12.916447368421053, 'BPF': 12.799999999999999, 'SC': 25.942424242424238, 'SSG': 20.130989583333335, 'SSF': 21.861111111111111, 'BSF': 11.155059523809523, 'SPF': 20.951572327044026, 'SPG': 25.910759493670888}, 'SA': {'BSG': 12.479797979797979, 'BC': 10.502222222222223, 'BPG': 14.314639639639639, 'BPF': 14.335416666666667, 'SC': 23.954411764705885, 'SSG': 22.227083333333333, 'SSF': 23.441538461538464, 'BSF': 11.979761904761904, 'SPF': 24.653731343283582, 'SPG': 28.962962962962962}}}
				# print self.defense_season_avgs
		elif self.sport=='MLB':
			pass

	def FD_points(self,df):
		if self.sport=='MLB':
			if df['Player_Type'][0] == 'batter':
				df['FD_points'] = (df['singles']*1+df['doubles']*2+df['triples']*3+
								df['home_runs']*4+df['rbi']*1+df['runs']*1+
									df['walks']*1+df['stolen_bases']*1+df['hit_by_pitch']*1+
									(df['at_bats'] -df['hits'])*-.25)
			else:
				df['FD_points']= (df['win']*4+df['earned_runs']*-1+
									df['strike_outs']*1+df['innings_pitched']*1)	
		elif self.sport=='NBA':
			df['FGM2']=df['FGM']-df['3FGM'] #calculate number of 2-point FGs made
			df[df['FGM2']<0]=0 #replace negative values (i.e. only three pointers made) with 0
			df['FD_points']=(df['3FGM']*3+df['FGM2']*2+df['FTM']*1+df['rebounds']*1.2+df['assists']*1.5+
								df['blocks']*2+df['steals']*2+df['turnovers']*-1)
		return df['FD_points']


	def median(self,df,feature,num_events):
		median_df =pd.rolling_median(df[feature.replace('_medn','')],window=num_events)
		return median_df.fillna(median_df.mean())

	def param_median(self,df,feature,num_events):
		medn =df[feature.replace('_medn','')].tail(num_events).median() #Ian: Cole, isn't this the same as just taking the last index of df[feature]? it will already be equal to the median of last X events
		if math.isnan(medn):
			return 0
		else:
			return medn

	def mean(self,df,feature,num_events):
		mean_df =pd.rolling_mean(df[feature.replace('_mean','')],window=num_events)
		return mean_df.fillna(mean_df.mean())

	def param_mean(self,df,feature,num_events):
		mean =df[feature.replace('_mean','')].tail(num_events).mean() #Ian: Cole, isn't this the same as just taking the last index of df[feature]? it will already be equal to the median of last X events
		if math.isnan(mean):
			return 0
		else:
			return mean

	def days_rest(self,df):
		df['days_rest']=(df['date']-df['date'].shift()).fillna(0)
		return df.apply(self.convert_days_to_int,axis=1)

	def convert_days_to_int(self,df):
		days_rest=df['days_rest']
		days_int=(days_rest/numpy.timedelta64(1, 'D')).astype(int)
		return (days_int if days_int<10 else 2) #Ian: we get values like 196 between seasons, or what if they were injured? will throw off modelling..

	def param_days_rest(self,df):
		df['days_rest']=(df['today']-df['date'].shift()).fillna(0)
		return df.apply(self.convert_days_to_int,axis=1).iloc[-1]

	def opposing_defense_PA(self,df): #Ian: points allowed by opposing defense to a certain position
		df['opponent']=df.apply(self.determine_opponent,axis=1)##identify opposing team
		df['season']=df.apply(self.determine_season,axis=1)
		df['mapped_position']=df.apply(self.position_mapping,axis=1)
		return df.apply(self.defense_season_avg,axis=1)
	
	def position_mapping(self,df):
		position=('SF' if df['position'] == ('F' or 'G') else df['position']) #replace 'G' or 'F' syntax used on xml stats
		return ('S'+position if df['starter']==1 else 'B'+position)

	def defense_season_avg(self,df):
		return self.defense_season_avgs[df['season']][df['opponent']][df['mapped_position']]

	def determine_season(self,df): #Ian: modify this once you get quarterly averages, etc.
		return [season for season,dates in self.seasons_dt.iteritems() if df['date']>=dates[0] and df['date']<=dates[1]][0]

	def param_opposing_defense_PA(self,df):
		df['mapped_position']=df.apply(self.position_mapping,axis=1)
		df['season']=df.apply(self.determine_season,axis=1)
		return self.defense_season_avgs[df['season'].iloc[-1]][df['matchup'].iloc[-1]][df['mapped_position'].iloc[-1]]


	def determine_opponent(self,df):
		return (df['away_team'] if df['team']==df['home_team'] else df['home_team'])

	def opposing_defense_stats(self,team,season):
		dateframe={"$gte":dt.datetime.strptime(self.seasons[season][0],'%Y-%m-%d'),
					"$lte":dt.datetime.strptime(self.seasons[season][1],'%Y-%m-%d')}
		db_df=pd.DataFrame(dbo.read_from_db('hist_event_data',{'sport':self.sport,'date':dateframe, "$or":[{'home_team':team}, 
									{'away_team':team}]},{'gameID':1,'home_team':1,'away_team':1,'sport':1,'_id':0}))
		db_df['team']=team #team is defensive team
		db_df['off_team']=db_df.apply(self.determine_opponent,axis=1)
		points_allowed_df=db_df.apply(self.position_FD_points,axis=1) #points allowed to opposing position in each game of season
		points_allowed={'SPG':points_allowed_df[0].mean(),'SSG':points_allowed_df[1].mean(),
						'SSF':points_allowed_df[2].mean(),'SPF':points_allowed_df[3].mean(),
						'SC':points_allowed_df[4].mean(),'BPG':points_allowed_df[5].mean(),
						'BSG':points_allowed_df[6].mean(),'BSF':points_allowed_df[7].mean(),
						'BPF':points_allowed_df[8].mean(),'BC':points_allowed_df[9].mean()}
		return points_allowed

	def position_FD_points(self,df): #Ian: could modify this so it returns points allowed to starters? bench players?? depending on which player you are modelling
		db_data=dbo.read_from_db('hist_player_data',{'gameID':df['gameID'],'sport':df['sport'],'team':df['off_team']},{'_id':0})
		db_data=[{key:[value] for key,value in player.iteritems()} for player in db_data] #pandas cannot convert scalars to a dataframe

		starter_points_allowed=[numpy.mean([self.FD_points(pd.DataFrame(player)).iloc[-1] for player in db_data 
								if (player['position'][0]==position and player['starter'][0]==1)]) for position in self.positions]
		bench_points_allowed=[numpy.mean([self.FD_points(pd.DataFrame(player)).iloc[-1] for player in db_data 
								if (player['position'][0]==position and player['starter'][0]==0)]) for position in self.positions]
		return pd.Series(starter_points_allowed+bench_points_allowed)













